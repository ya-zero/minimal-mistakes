---
title: "Перенос отдельно стоящего nat сервера на сервер BRAS "
date: 2018-12-11 09:00:00 +0000
categories:
  - NAT
tags:
  - accel-ppp
  - debian
  - persistent
sidebar:
  - title: "Debian NAT"
    text: "настройка nat"
---

На accel-ppp был отключен connection tracking для абонентских сетей
```bash
#iptables -t raw -L -n
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  192.168.0.0/24       0.0.0.0/0           
ACCEPT     all  --  10.2.1.0/24          0.0.0.0/0           
ACCEPT     all  --  0.0.0.0/0            192.168.0.0/24      
ACCEPT     all  --  0.0.0.0/0            10.2.1.0/24         
NOTRACK    all  --  0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            192.168.0.0/24      
ACCEPT     all  --  0.0.0.0/0            10.2.1.0/24         
ACCEPT     all  --  192.168.0.0/24       0.0.0.0/0           
ACCEPT     all  --  10.2.1.0/24          0.0.0.0/0           
NOTRACK    all  --  0.0.0.0/0            0.0.0.0/0     
```
Нужно либо переписать правило NOTRACK 0.0.0.0 на ACCEPT,  либо удалить его .  
Оптимальнее всего убрать правила из цепочки RAW.

выполним через консоль 

```bash
iptables -t raw -F PREROUTING
iptables -t raw -F OUTPUT
```

Проверим с помощью пакета conntrack -L | wc -l 
сколько у нас записей.  

Теперь нагрузка ляжет на проц. для оптимизации таблицы необходимо будет править /etc/sysctl.conf
ту часть что отвечает за соединения 

net.netfilter.nf_conntrack_generic_timeout = 60
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 15
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 30
net.netfilter.nf_conntrack_tcp_timeout_established = 900
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 30
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 20
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 30
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 30
net.netfilter.nf_conntrack_tcp_timeout_close = 10
net.netfilter.nf_conntrack_udp_timeout = 30
net.netfilter.nf_conntrack_udp_timeout_stream = 45
net.netfilter.nf_conntrack_icmp_timeout = 10

#для  работы GRE тунелей добавим 
net.netfilter.nf_conntrack_helper = 1

                                      #Проверим что бы были строки
net.ipv4.ip_forward=1
#  увелечение   максимальноко колличества сейссий
net.nf_conntrack_max=1548576



