---
title: "Встала задача перености отдельно стоящего nat сервера на  BRAS сервер "
date: 2018-12-11 09:00:00 +0000
categories:
  - NAT
tags:
  - accel-ppp
  - debian
  - persistent
sidebar:
  - title: "Debian NAT"
    text: "настройка nat"
---

На accel-ppp был отключен connection tracking для абонентских сетей
```bash
#iptables -t raw -L -n
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  192.168.0.0/24       0.0.0.0/0           
ACCEPT     all  --  10.2.1.0/24          0.0.0.0/0           
ACCEPT     all  --  0.0.0.0/0            192.168.0.0/24      
ACCEPT     all  --  0.0.0.0/0            10.2.1.0/24         
NOTRACK    all  --  0.0.0.0/0            0.0.0.0/0           

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            192.168.0.0/24      
ACCEPT     all  --  0.0.0.0/0            10.2.1.0/24         
ACCEPT     all  --  192.168.0.0/24       0.0.0.0/0           
ACCEPT     all  --  10.2.1.0/24          0.0.0.0/0           
NOTRACK    all  --  0.0.0.0/0            0.0.0.0/0     
```
Нужно либо переписать правило NOTRACK all 0.0.0.0/0 на ACCEPT,  либо удалить его .  
Оптимальнее всего убрать все правила из цепочки RAW.

выполним через консоль 

```bash
iptables -t raw -F PREROUTING
iptables -t raw -F OUTPUT
```
и сохраним изменеия в скрипте который подгружает правила при старте. 


Как проверить сколько у нас записей в таблице connaction tracking ,
это делается с помощью пакета conntrack -L | wc -l 

Что будем тюнить :
![]({{ site.baseurl }}/uploads/Figure-1-Data-receiving-process.jpg "nic tune")

best practics :
https://fasterdata.es.net/host-tuning/linux/

Если сервер работает только маршрутизатором, то тюнинг TCP стека особого значения не имеет, кроме тюнинга параметров касаемых производительносит сетевой карты (buffer)

Теперь нагрузка ляжет на проц. для оптимизации таблицы необходимо будет править /etc/sysctl.conf
ту часть что отвечает за соединения :

#net.netfilter.nf_conntrack_tcp_timeout_established = 900 (default 432000 = 120 часов )
помнить сессию 5 дней если даже если по ней пробежал один байт

#для  работы GRE тунелей добавим  в debian stretch
net.netfilter.nf_conntrack_helper = 1


Проверим что бы были строки :

net.ipv4.ip_forward=1 # 

net.nf_conntrack_max=262144  #увеличение максимальноко колличества сейссий   conntrack_buckets * 4
                             #для избежания сообщений nf_conntrack: table full, dropping packet в dmesg 
                             #при ddos или flood от абонента
net.netfilter.nf_conntrack_buckets = 65536 

Сетевые параметры  ядра описаны на странице :
https://www.kernel.org/doc/Documentation/networking/nf_conntrack-sysctl.txt
```
nf_conntrack_buckets - INTEGER
	Size of hash table. If not specified as parameter during module
	loading, the default size is calculated by dividing total memory
	by 16384 to determine the number of buckets but the hash table will
	never have fewer than 32 and limited to 16384 buckets. For systems
	with more than 4GB of memory it will be 65536 buckets.
	This sysctl is only writeable in the initial net namespace.
```

